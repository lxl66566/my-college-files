<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>人脸亮牙</title>
    <style>
      canvas {
        border: 1px solid black;
        width: auto;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <input type="file" @change="loadImageEvent" />
      <canvas ref="canvas"></canvas>
      <button @click="enhanceTeeth">亮牙</button>
    </div>

    <script src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script>
      const face_xml_path = "https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml";

      new Vue({
        el: "#app",
        data: {
          imageSrc: null,
          afterImageSrc: null,
        },
        mounted() {
          this.loadImage("/1.png");
        },
        methods: {
          loadImage(src) {
            if (src) {
              this.imageSrc = src;
              const img = new Image();
              img.src = this.imageSrc;
              img.onload = () => {
                const canvas = this.$refs.canvas;
                const ctx = canvas.getContext("2d");
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              };
            }
          },
          loadImageEvent(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
              this.loadImage(e.target.result);
            };
            reader.readAsDataURL(file);
          },
          // https://stackoverflow.com/questions/67832067/using-javascript-to-load-haarcascasdes-file-always-return-false
          createFileFromUrl(url, callback) {
            // url: path of the actual file on your FS
            // callback: what to do when file is loaded

            const path = "haarcascade";
            let request = new XMLHttpRequest();
            request.open("GET", url, true);
            request.responseType = "arraybuffer";
            request.onload = function (ev) {
              request = this;
              if (request.readyState === 4) {
                if (request.status === 200) {
                  let data = new Uint8Array(request.response);
                  cv.FS_createDataFile("/", path, data, true, false, false);
                  callback(path);
                } else {
                  console.error("Failed to load " + url + " status: " + request.status);
                }
              }
            };
            request.send();
          },
          enhanceTeeth() {
            const canvas = this.$refs.canvas;
            const ctx = canvas.getContext("2d");
            const src = cv.imread(canvas);
            const gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            this.createFileFromUrl(face_xml_path, (path) => {
              console.log(`${path} loaded`);

              // 加载 Haar 级联分类器
              const mouthCascade = new cv.CascadeClassifier(path);

              // 检测人脸
              const faces = new cv.RectVector();
              mouthCascade.detectMultiScale(gray, faces);
              console.log(`faces num: ${faces.size()}`);
              const face = faces.get(0);

              // 在人脸区域下半部分检测嘴巴
              const mouthROI = new cv.Rect(face.x + face.width / 4, face.y + (face.height / 3) * 2, face.width / 2, face.height / 3);
              // const mouthROI = new cv.Rect(face.x, face.y, face.width, face.height);
              console.log(`mouth ROI: ${mouthROI.x}, ${mouthROI.y}, ${mouthROI.width}, ${mouthROI.height}`);

              // 绘制检测结果
              ctx.beginPath();
              ctx.rect(mouthROI.x, mouthROI.y, mouthROI.width, mouthROI.height);
              ctx.lineWidth = 2;
              ctx.strokeStyle = "red";
              ctx.stroke();

              // const mouthRegion = src.roi(mouthROI);

              // // 提升牙齿区域的亮度
              // const teethMask = new cv.Mat();
              // cv.inRange(mouthRegion, new cv.Scalar(200, 200, 200), new cv.Scalar(255, 255, 255), teethMask);
              // const brightnessFactor = 1.5;
              // const enhancedTeeth = new cv.Mat();
              // cv.multiply(mouthRegion, new cv.Scalar(brightnessFactor, brightnessFactor, brightnessFactor, 1), enhancedTeeth, 1, cv.CV_8UC4);
              // enhancedTeeth.copyTo(mouthRegion, teethMask);

              // 释放内存
              teethMask.delete();
              enhancedTeeth.delete();

              cv.imshow(canvas, src);
              src.delete();
              gray.delete();
              faces.delete();
            });
          },
        },
      });
    </script>
  </body>
</html>
